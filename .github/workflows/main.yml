name: üî¨ Compare & üöÄ Publish Profiles (Parallel)

on:
  workflow_dispatch:

jobs:
  prepare-matrix:
    name: üìÑ Prepare comparison matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3

      - name: üîß Install yq and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y yq jq curl

      - name: ‚òï Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: üòá Download validator_cli.jar
        run: |
          curl -L -o validator_cli.jar http://horvac.de/org.hl7.fhir.validation.cli-6.4.0.jar

      - name: ‚öñÔ∏è Read ComparisonConfig.yml
        id: set-matrix
        run: |
          CONFIG_PATH=.github/config/ComparisonConfig.yml
          json=$(yq '.profiles' "$CONFIG_PATH" | jq -c .)
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

      - name: üì§ Upload validator_cli.jar for reuse
        uses: actions/upload-artifact@v4
        with:
          name: validator
          path: validator_cli.jar

  compare:
    name: üî¨ Compare ${{ matrix.profile.dest }}
    runs-on: ubuntu-latest
    needs: prepare-matrix
    strategy:
      matrix:
        profile: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
      max-parallel: 4

    env:
      ERROR_PATH: Comparison/ComparisonErrors

    steps:
      - uses: actions/checkout@v3

      - name: üîß Set up tools
        run: |
          sudo apt-get update -y -o Acquire::Retries=3 -o Acquire::http::Timeout=30
          sudo apt-get install -y --no-install-recommends yq curl

      - name: üö´ Ensure error path exists
        run: mkdir -p $ERROR_PATH

      - name: ‚òï Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: üì• Download validator_cli.jar
        uses: actions/download-artifact@v4
        with:
          name: validator

      - name: üîß Set artifact name
        id: vars
        run: echo "artifact_name=$(basename ${{ matrix.profile.dest }})" >> $GITHUB_OUTPUT

      - name: üî¨ Run comparison
        run: |
          dest=${{ matrix.profile.dest }}
          name=$(basename $dest)
          leftIg=$(echo ${{ matrix.profile.leftIg }} | sed 's/@/#/')
          rightIg=$(echo ${{ matrix.profile.rightIg }} | sed 's/@/#/')
          leftProfile=${{ matrix.profile.leftProfile }}
          rightProfile=${{ matrix.profile.rightProfile }}

          mkdir -p $dest
          echo "üî¨ Comparing $name"

          if JAVA_TOOL_OPTIONS=-Djava.awt.headless=true \
            java -jar validator_cli.jar -compare -dest $dest -version 4.0 \
            -ig $leftIg -ig $rightIg -left $leftProfile -right $rightProfile > $dest/compare.log 2>&1; then
            echo "‚úÖ $name comparison succeeded"
          else
            echo "‚ùå $name comparison failed"
            cp $dest/compare.log $ERROR_PATH/${name}.log
          fi

      - name: üì§ Upload comparison result
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.artifact_name }}
          path: ${{ matrix.profile.dest }}

  post-process:
    name: ü™© Generate Index & Deploy
    runs-on: ubuntu-latest
    needs: compare

    steps:
      - uses: actions/checkout@v3

      - name: üì• Download all comparison results
        uses: actions/download-artifact@v4
        with:
          path: Comparison

      - name: üëê Generate central index.html
        run: |
          INDEX_PATH="Comparison/index.html"
          ERROR_DIR="Comparison/ComparisonErrors"
          mkdir -p "$ERROR_DIR"
          echo "<html><head><title>Overview</title></head><body><h1>Result overview</h1><ul>" > "$INDEX_PATH"

          for d in Comparison/*/ ; do
            name=$(basename "$d")
            if [[ "$name" == "ComparisonErrors" ]]; then continue; fi
            if [[ -f "$d/index.html" ]]; then
              echo "<li><a href=\"$name/index.html\">$name</a></li>" >> "$INDEX_PATH"
            elif [[ -f "$ERROR_DIR/${name}.log" ]]; then
              echo "<li><strong>$name</strong>: ‚ùå Failed ‚Äì <a href=\"ComparisonErrors/${name}.log\">View error log</a></li>" >> "$INDEX_PATH"
            else
              echo "<li><strong>$name</strong>: ‚ö†Ô∏è No result found</li>" >> "$INDEX_PATH"
            fi
          done

          echo "</ul></body></html>" >> "$INDEX_PATH"

      - name: üöÄ Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'Comparison'
