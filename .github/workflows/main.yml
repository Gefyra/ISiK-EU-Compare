name: Validate Profiles

on:
  push:
    branches: [ "main" ]
  
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    env:
      CONFIG_PATH: .github/config/ComparisonConfig.yml

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Copy manually unpacked packages into Firely cache
        run: |
          CACHE_DIR="$HOME/.fhir/packages"
      
          if [ -d "UnpublishedPackages" ]; then
            for pkgdir in UnpublishedPackages/*; do
              if [ -d "$pkgdir/package" ]; then
                basename=$(basename "$pkgdir")
                pkg_name=$(echo "$basename" | sed 's/-[0-9].*//')
                pkg_ver=$(echo "$basename" | sed "s/^$pkg_name-//")
      
                target_dir="$CACHE_DIR/$pkg_name/$pkg_ver"
                echo "üìÇ Copying $pkgdir ‚Üí $target_dir"
      
                mkdir -p "$target_dir"
                cp -r "$pkgdir/package" "$target_dir/"
              else
                echo "‚ö†Ô∏è Skipping $pkgdir ‚Äì no 'package/' subfolder found"
              fi
            done
          else
            echo "‚ÑπÔ∏è No UnpublishedPackages directory found ‚Äì skipping"
          fi
      
#      - name: Install unpublished packages
#        run: |
#          if [ -d "UnpublishedPackages" ]; then
#            for tgz in UnpublishedPackages/*.tgz; do
#              if [ -f "$tgz" ]; then
#                echo "üì¶ Installing unpublished package: $tgz"
#                fhir install "$tgz" --file
#              fi
#            done
#          else
#            echo "‚ÑπÔ∏è No UnpublishedPackages directory found ‚Äì skipping"
#          fi

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          check-latest: true

      - name: Install yq
        run: |
          sudo apt-get update
          sudo apt-get install -y yq

      - name: Download validator_cli.jar
        run: |
          curl -L -o validator_cli.jar https://github.com/hapifhir/org.hl7.fhir.core/releases/download/6.5.21/validator_cli.jar
          
      - name: Install Firely Terminal
        run: dotnet tool install --global firely.terminal --version 3.2.0
        
      - name: Parse and preload FHIR packages
        run: |
          yq '.profiles[] | .leftIg, .rightIg' "$CONFIG_PATH" | tr -d '"' | sort -u | while read pkg; do
            if fhir install "$pkg"; then
              echo "‚úÖ $pkg installed"
            else
              echo "‚ùå Failed to install $pkg ‚Äì skipping"
            fi
          done
      
      - name: Run validations
        run: |
          profiles=$(yq '.profiles | length' "$CONFIG_PATH")
          for i in $(seq 0 $((profiles - 1))); do
            dest=$(yq ".profiles[$i].dest" "$CONFIG_PATH")
            leftIg=$(yq ".profiles[$i].leftIg" "$CONFIG_PATH" | tr -d '"' | sed 's/@/#/')
            rightIg=$(yq ".profiles[$i].rightIg" "$CONFIG_PATH" | tr -d '"' | sed 's/@/#/')
            leftProfile=$(yq ".profiles[$i].leftProfile" "$CONFIG_PATH")
            rightProfile=$(yq ".profiles[$i].rightProfile" "$CONFIG_PATH")

            echo "Preparing destination folder: $dest"
            rm -rf "$dest"
            mkdir -p "$dest"

            echo "Running validation for entry $i"
            java -jar validator_cli.jar -compare -dest "$dest" -version 4.0 -ig "$leftIg" -ig "$rightIg" -left "$leftProfile" -right "$rightProfile"
          done

      - name: Generate central index.html
        run: |
          echo "<html><head><title>Vergleichs√ºbersicht</title></head><body><h1>Vergleichsergebnisse</h1><ul>" > Comparison/index.html
          
          for d in Comparison/*/ ; do
            name=$(basename "$d")
            if [[ -f "$d/index.html" ]]; then
              echo "<li><a href=\"$name/index.html\">$name</a></li>" >> Comparison/index.html
            fi
          done
          
          echo "</ul></body></html>" >> Comparison/index.html

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git diff --cached --quiet || git commit -m "chore: update validation results [automated]"
          git push

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          publish_dir: ./Comparison