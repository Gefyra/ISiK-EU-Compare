name: üî¨ Compare & üöÄ Publish Profiles (Parallel)

on:
  workflow_dispatch:

jobs:
  prepare-matrix:
    name: üìÑ Prepare comparison matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3

      - name: üîß Install yq
        run: |
          sudo apt-get update
          sudo apt-get install -y yq

      - name: ‚öñÔ∏è Read ComparisonConfig.yml
        id: set-matrix
        run: |
          CONFIG_PATH=.github/config/ComparisonConfig.yml
          json=$(yq -o=json '.profiles' "$CONFIG_PATH")
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  compare:
    name: üî¨ Compare ${{ matrix.profile.dest }}
    runs-on: ubuntu-latest
    needs: prepare-matrix
    strategy:
      matrix:
        profile: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
      max-parallel: 4

    env:
      VALIDATOR_DOWNLOAD_URL: http://horvac.de/org.hl7.fhir.validation.cli-6.4.0.jar
      ERROR_PATH: Comparison/ComparisonErrors

    steps:
      - uses: actions/checkout@v3

      - name: ‚òï Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: üîß Set up tools
        run: |
          sudo apt-get update
          sudo apt-get install -y yq curl

      - name: üö´ Ensure error path exists
        run: mkdir -p $ERROR_PATH

      - name: üòá Download validator_cli.jar
        run: |
          curl -L -o validator_cli.jar $VALIDATOR_DOWNLOAD_URL

      - name: üî¨ Run comparison
        run: |
          dest="${{ matrix.profile.dest }}"
          name=$(basename "$dest")
          leftIg="${{ matrix.profile.leftIg }}" | sed 's/@/#/'
          rightIg="${{ matrix.profile.rightIg }}" | sed 's/@/#/'
          leftProfile="${{ matrix.profile.leftProfile }}"
          rightProfile="${{ matrix.profile.rightProfile }}"

          mkdir -p "$dest"
          echo "üî¨ Comparing $name"

          if JAVA_TOOL_OPTIONS=-Djava.awt.headless=true \
            java -jar validator_cli.jar -compare -dest "$dest" -version 4.0 \
            -ig "$leftIg" -ig "$rightIg" -left "$leftProfile" -right "$rightProfile" > "$dest/compare.log" 2>&1; then
            echo "‚úÖ $name comparison succeeded"
          else
            echo "‚ùå $name comparison failed"
            cp "$dest/compare.log" "$ERROR_PATH/${name}.log"
          fi

  post-process:
    name: ü™© Generate Index & Deploy
    runs-on: ubuntu-latest
    needs: compare

    steps:
      - uses: actions/checkout@v3

      - name: üîß Install yq
        run: |
          sudo apt-get update
          sudo apt-get install -y yq

      - name: üëê Generate central index.html
        run: |
          INDEX_PATH="Comparison/index.html"
          ERROR_DIR="Comparison/ComparisonErrors"
          mkdir -p "$ERROR_DIR"
          echo "<html><head><title>Overview</title></head><body><h1>Result overview</h1><ul>" > "$INDEX_PATH"

          for d in Comparison/*/ ; do
            name=$(basename "$d")
            if [[ "$name" == "ComparisonErrors" ]]; then continue; fi
            if [[ -f "$d/index.html" ]]; then
              echo "<li><a href=\"$name/index.html\">$name</a></li>" >> "$INDEX_PATH"
            elif [[ -f "$ERROR_DIR/${name}.log" ]]; then
              echo "<li><strong>$name</strong>: ‚ùå Failed ‚Äì <a href=\"ComparisonErrors/${name}.log\">View error log</a></li>" >> "$INDEX_PATH"
            else
              echo "<li><strong>$name</strong>: ‚ö†Ô∏è No result found</li>" >> "$INDEX_PATH"
            fi
          done

          echo "</ul></body></html>" >> "$INDEX_PATH"

      - name: üöÄ Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'Comparison'
