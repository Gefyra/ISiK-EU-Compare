name: ğŸ”¬ Compare & ğŸš€ Publish Profiles

on:
#  push:
#    branches: [ "main" ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    env:
      VALIDATOR_DOWNLOAD_URL: http://horvac.de/org.hl7.fhir.validation.cli-6.4.0.jar #org.hl7.fhir.validation.cli-6.5.22-SNAPSHOT.jar
      CONFIG_PATH: .github/config/ComparisonConfig.yml

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ Copy manually unpacked packages into Firely cache
        run: |
          CACHE_DIR="$HOME/.fhir/packages"
          if [ -d "PackagesForCache" ]; then
            for pkgdir in PackagesForCache/*; do
              if [ -d "$pkgdir/package" ]; then
                pkg_id=$(basename "$pkgdir")
                target_dir="$CACHE_DIR/$pkg_id"
                echo "ğŸ“‚ Copying $pkgdir â†’ $target_dir"
                mkdir -p "$target_dir"
                cp -r "$pkgdir/package" "$target_dir/"
              else
                echo "âš ï¸ Skipping $pkgdir â€“ no 'package/' subfolder found"
              fi
            done
          else
            echo "â„¹ï¸ No PackagesForCache directory found â€“ skipping"
          fi

      - name: â˜• Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          check-latest: true

      - name: ğŸ§° Install yq
        run: |
          sudo apt-get update
          sudo apt-get install -y yq

      - name: â¬‡ï¸ Download validator_cli.jar
        run: |
          curl -L -o validator_cli.jar $VALIDATOR_DOWNLOAD_URL

      - name: ğŸ”¬ Run compare
        run: |
          profiles=$(yq '.profiles | length' "$CONFIG_PATH")
          echo "| Profile | Status |" > compare_results.md
          echo "|---------|--------|" >> compare_results.md
          mkdir -p ComparisonErrors

          for i in $(seq 0 $((profiles - 1))); do
            dest=$(yq ".profiles[$i].dest" "$CONFIG_PATH" | tr -d '"')
            name=$(basename "$dest")
            leftIg=$(yq ".profiles[$i].leftIg" "$CONFIG_PATH" | tr -d '"' | sed 's/@/#/')
            rightIg=$(yq ".profiles[$i].rightIg" "$CONFIG_PATH" | tr -d '"' | sed 's/@/#/')
            leftProfile=$(yq ".profiles[$i].leftProfile" "$CONFIG_PATH" | tr -d '"')
            rightProfile=$(yq ".profiles[$i].rightProfile" "$CONFIG_PATH" | tr -d '"')

            echo "ğŸ“ Preparing destination folder: $dest"
            rm -rf "$dest"
            mkdir -p "$dest"

            echo "ğŸ§ª Running validation for $name"
            if JAVA_TOOL_OPTIONS=-Djava.awt.headless=true \
              java -jar validator_cli.jar -compare -dest "$dest" -version 4.0 \
              -ig $leftIg -ig $rightIg -left $leftProfile -right $rightProfile > "$dest/compare.log" 2>&1; then
              echo "| $name | âœ… Success |" >> compare_results.md
            else
              echo "| $name | âŒ Failed |" >> compare_results.md
              cp "$dest/compare.log" "ComparisonErrors/${name}.log"
            fi
          done

          echo ""
          echo "::group::ğŸ”¬ Vergleichsergebnisse"
          cat compare_results.md
          echo "::endgroup::"


      - name: ğŸ”— Add home link to all pages
        run: |
          find . -type f -name "*.html" | while read -r file; do
            if ! grep -q 'https://gefyra.github.io/ISiK-EU-Compare' "$file"; then
              sed -i '/<body[^>]*>/a\
              <div style="padding: 1em; background: #f2f2f2; border-bottom: 1px solid #ccc;">\
                <a href="https://gefyra.github.io/ISiK-EU-Compare">Home</a>\
              </div>' "$file"
            fi
          done

      - name: ğŸ§­ Generate central index.html
        run: |
          rm -f Comparison/index.html
          echo "<html><head><title>Overview</title></head><body><h1>Result overview</h1><ul>" >> Comparison/index.html

          for d in Comparison/*/ ; do
            name=$(basename "$d")
            if [[ -f "$d/index.html" ]]; then
              echo "<li><a href=\"$name/index.html\">$name</a></li>" >> Comparison/index.html
            elif [[ -f "ComparisonErrors/${name}.log" ]]; then
              errmsg=$(head -n 1 "ComparisonErrors/${name}.log" | sed 's/</\&lt;/g; s/>/\&gt;/g')
              echo "<li><strong>$name</strong>: âŒ Failed â€“ $errmsg</li>" >> Comparison/index.html
            else
              echo "<li><strong>$name</strong>: âš ï¸ No result found</li>" >> Comparison/index.html
            fi
          done

          echo "</ul></body></html>" >> Comparison/index.html


      - name: ğŸ§¹ Remove validator_cli.jar before commit
        run: |
          echo "ğŸ—‘ï¸ Removing validator_cli.jar before committing..."
          rm -f validator_cli.jar

      - name: ğŸ’¾ Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet || git commit -m "chore: update validation results [automated]"
          git push

      - name: ğŸš€ Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'Comparison'
