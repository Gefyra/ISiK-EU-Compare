name: ğŸ”¬ Compare & ğŸš€ Publish Profiles (Parallel)

on:
  workflow_dispatch:
    inputs:
      run_all:
        description: 'Run all comparisons regardless of history'
        type: boolean
        default: false

jobs:
  prepare-matrix:
    name: ğŸ“„ Prepare comparison matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      today: ${{ steps.cache-meta.outputs.today }}
      total: ${{ steps.set-matrix.outputs.total }}
      selected: ${{ steps.set-matrix.outputs.selected }}
      hasSelections: ${{ steps.set-matrix.outputs.hasSelections }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“… Prepare cache metadata
        id: cache-meta
        run: node scripts/prepare-cache-meta.js

      - name: ğŸ”„ Restore cache for validator_cli.jar
        uses: actions/cache@v3
        with:
          path: tmp/validator_cli.jar
          key: ${{ runner.os }}-validator-cli-${{ steps.cache-meta.outputs.today }}
          restore-keys: |
            ${{ runner.os }}-validator-cli-

      - name: ğŸ˜‡ Fetch validator_cli.jar
        run: node scripts/fetch-validator.js

      - name: ğŸ’¾ Save cache for validator_cli.jar
        uses: actions/cache@v3
        with:
          path: tmp/validator_cli.jar
          key: ${{ runner.os }}-validator-cli-${{ steps.cache-meta.outputs.today }}

      - name: âš–ï¸ Read ComparisonConfig.yml
        id: set-matrix
        run: node scripts/prepare-matrix.js
        env:
          RUN_ALL_COMPARISONS: ${{ inputs.run_all }}

  compare:
    name: ğŸ”¬ Compare ${{ matrix.profile.dest }}
    runs-on: ubuntu-latest
    needs: prepare-matrix
    strategy:
      matrix:
        profile: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
      max-parallel: 4

    steps:
      - uses: actions/checkout@v3

      - name: ğŸŸ¢ Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸš« Ensure paths exists
        run: node scripts/ensure-dirs.js tmp

      - name: â˜• Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ğŸ”„ Restore cache for validator_cli.jar
        uses: actions/cache@v3
        with:
          path: tmp/validator_cli.jar
          key: ${{ runner.os }}-validator-cli-${{ needs.prepare-matrix.outputs.today }}
          restore-keys: |
            ${{ runner.os }}-validator-cli-

      - name: ğŸ˜‡ Fetch validator_cli.jar
        run: node scripts/fetch-validator.js

      - name: ğŸ“¦ Install and cache IG packages
        run: npm run install-igs -- --sync-cache

      - name: ğŸ”¬ Run comparison
        run: |
          node scripts/run-comparison.js \
            --dest "${{ matrix.profile.dest }}" \
            --left-ig "${{ matrix.profile.leftIg }}" \
            --right-ig "${{ matrix.profile.rightIg }}" \
            --left-profile "${{ matrix.profile.leftProfile }}" \
            --right-profile "${{ matrix.profile.rightProfile }}"

      - name: ğŸ“¤ Upload comparison result
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.profile.artifactName }}
          path: ${{ matrix.profile.dest }}
          retention-days: 1

  post-process:
    name: ğŸª© Generate Index & Deploy
    runs-on: ubuntu-latest
    needs:
      - prepare-matrix
      - compare

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¥ Download all comparison results
        if: needs.prepare-matrix.outputs.hasSelections == 'true'
        uses: actions/download-artifact@v4
        with:
          path: Comparison

      - name: ğŸ§¾ Update comparison history
        run: node scripts/update-history.js
        env:
          FILTERED_MATRIX: ${{ needs.prepare-matrix.outputs.matrix }}

      - name: ğŸ‘ Generate central index.html
        if: needs.prepare-matrix.outputs.hasSelections == 'true'
        run: node scripts/generate-index.js

      - name: ğŸš€ Deploy to GitHub Pages
        if: needs.prepare-matrix.outputs.hasSelections == 'true'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'Comparison'

      - name: ğŸ’¾ Commit updated comparison history
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: update comparison history'
          file_pattern: metadata/comparison-history.json
          branch: ${{ github.ref_name }}
