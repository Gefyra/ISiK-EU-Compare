name: ✅ Validate ISiK Instances

on:
    push:
      branches:
        - 'feature/**'
  
    workflow_dispatch:
    

jobs:
  validate-instances:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: 🔧 Setup tools
        uses: ./.github/actions/setup-tools

      - name: 📂 Validate ISiK Examples against EU Profiles
        run: |
          CONFIG_PATH=.github/config/InstanceValidationConfig.yml
          count=$(yq '.instances | length' "$CONFIG_PATH")
          echo "Validating $count example instances..."

          mkdir -p ValidationResults

          for i in $(seq 0 $((count - 1))); do
            name=$(yq ".instances[$i].name" "$CONFIG_PATH" | tr -d '"')
            file=$(yq ".instances[$i].file" "$CONFIG_PATH" | tr -d '"')
            profile=$(yq ".instances[$i].profile" "$CONFIG_PATH" | tr -d '"')

            echo "🧪 Validating $name using profile $profile..."

            # Replace meta.profile (JSON only)
            if [[ "$file" == *.json ]]; then
              jq --arg p "$profile" '.meta.profile = [$p]' "$file" > "$file.tmp" && mv "$file.tmp" "$file"
              echo "🔧 meta.profile in $file updated"
            fi

            if JAVA_TOOL_OPTIONS=-Djava.awt.headless=true \
              java -jar tmp/validator_cli.jar "$file" -version 4.0 -profile "$profile" > "ValidationResults/$name.log" 2>&1; then
              echo "✅ $name valid" >> "ValidationResults/$name.log"
            else
              echo "❌ $name failed validation" >> "ValidationResults/$name.log"
            fi
          done


      - name: 📤 Upload validation logs
        uses: actions/upload-artifact@v4
        with:
          name: ValidationResults
          path: ValidationResults
